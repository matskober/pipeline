<?xml version="1.0" encoding="UTF-8"?>
<x:description xmlns:x="http://www.daisy.org/ns/xprocspec"
               xmlns:dotify="http://code.google.com/p/dotify/"
               xmlns:p="http://www.w3.org/ns/xproc"
               xmlns:pxi="http://www.daisy.org/ns/pipeline/xproc/internal"
               xmlns:cx="http://xmlcalabash.com/ns/extensions"
               script="dotify-format.xpl">
  
  <x:scenario label="test_01">
    <x:documentation>
      Tests page styles with different dimensions in the same document.
    </x:documentation>
    <x:call step="dotify:format">
      <x:input port="source">
        <x:document type="inline">
          <doc style="text-transform:none">
            <body style="@page { size: 15 5 }">
              <frontmatter style="{ display: block } @page { size: 30 5 }">
                ⠤⠤⠤
              </frontmatter>
              <bodymatter style="display: block">
                ⠤⠤⠤
              </bodymatter>
              <rearmatter style="{ display: block } @page { size: 30 5 }">
                ⠤⠤⠤
              </rearmatter>
            </body>
          </doc>
        </x:document>
      </x:input>
    </x:call>
    <x:context label="obfl">
      <x:document type="port" port="obfl"/>
    </x:context>
    <x:expect label="obfl" type="custom" href="http://www.daisy.org/pipeline/modules/braille/obfl-utils/library.xpl" step="x:obfl-compare">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false" translate="pre-translated-text-css">
          <layout-master name="a" page-width="30" page-height="5" duplex="true" page-number-variable="page">
            <default-template>
              <header/>
              <footer/>
            </default-template>
          </layout-master>
          <layout-master name="b" page-width="15" page-height="5" duplex="true" page-number-variable="page">
            <default-template>
              <header/>
              <footer/>
            </default-template>
          </layout-master>
          <sequence master="a">
            <block>
              ⠤⠤⠤
            </block>
          </sequence>
          <sequence master="b">
            <block>
              ⠤⠤⠤
            </block>
          </sequence>
          <sequence master="a">
            <block>
              ⠤⠤⠤
            </block>
          </sequence>
        </obfl>
      </x:document>
    </x:expect>
    <x:context label="pef">
      <x:document type="port" port="result"/>
    </x:context>
    <x:expect label="pef" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
      <x:document type="inline">
        <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
          <head xmlns:dc="http://purl.org/dc/elements/1.1/">
            <meta>
              <dc:format>application/x-pef+xml</dc:format>
            </meta>
          </head>
          <body>
            <volume rows="5" cols="30" rowgap="0" duplex="true">
              <section>
                <page>
                  <row>⠤⠤⠤</row>
                </page>
              </section>
              <section cols="15">
                <page>
                  <row>⠤⠤⠤</row>
                </page>
              </section>
              <section>
                <page>
                  <row>⠤⠤⠤</row>
                </page>
              </section>
            </volume>
          </body>
        </pef>
      </x:document>
    </x:expect>
  </x:scenario>
  
  <x:scenario label="test_02">
    <x:documentation>
      Tests rendering print page, running header and running footer in page margin. The strings are
      set, and sometimes emptied, individually at various places in the document.
    </x:documentation>
    <x:call step="dotify:format">
      <x:input port="source">
        <x:document type="inline">
          <doc style="text-transform:none">
            <body style="@page {
                         size: 20 5;
                         @top-center { content: string(running-header) }
                         @bottom-right { content: string(print-page) }
                         @bottom-center { content: string(running-footer) }}">
              <section style="display: block;">
                ⠤⠤⠤
              </section>
              <section style="display: block;
                              page-break-before: always;
                              string-set: print-page '⠤'">
                ⠤⠤⠤
              </section>
              <section style="display: block;
                              page-break-before: always;
                              string-set: print-page '⠤⠤', running-footer '⠤⠤'">
                ⠤⠤⠤
              </section>
              <section style="display: block;
                              page-break-before: always;
                              string-set: print-page '', running-header '⠤⠤'">
                ⠤⠤⠤
              </section>
              <section style="display: block;
                              page-break-before: always;
                              string-set: print-page '⠤⠤⠤', running-footer ''">
                ⠤⠤⠤
              </section>
            </body>
          </doc>
        </x:document>
      </x:input>
    </x:call>
    <x:context label="obfl">
      <x:document type="port" port="obfl"/>
    </x:context>
    <x:expect label="obfl" type="custom" href="http://www.daisy.org/pipeline/modules/braille/obfl-utils/library.xpl" step="x:obfl-compare">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false" translate="pre-translated-text-css">
          <layout-master name="a" page-width="20" page-height="5" duplex="true" page-number-variable="page">
            <default-template>
              <header>
                <field>
                  <string value=""/>
                </field>
                <field>
                  <marker-reference marker="running-header" direction="forward" scope="page" text-style="/-dotify-def:tmp_.+/"/>
                  <marker-reference marker="running-header" direction="backward" scope="sequence" text-style="/-dotify-defifndef:tmp_.+/"/>
                  <marker-reference marker="running-header/entry" direction="backward" scope="sequence" text-style="/-dotify-ifndef:tmp_.+/"/>
                </field>
                <field>
                  <string value=""/>
                </field>
              </header>
              <footer>
                <field>
                  <string value=""/>
                </field>
                <field>
                  <marker-reference marker="running-footer" direction="forward" scope="page" text-style="/-dotify-def:tmp_.+/"/>
                  <marker-reference marker="running-footer" direction="backward" scope="sequence" text-style="/-dotify-defifndef:tmp_.+/"/>
                  <marker-reference marker="running-footer/entry" direction="backward" scope="sequence" text-style="/-dotify-ifndef:tmp_.+/"/>
                </field>
                <field>
                  <marker-reference marker="print-page" direction="forward" scope="page" text-style="/-dotify-def:tmp_.+/"/>
                  <marker-reference marker="print-page" direction="backward" scope="sequence" text-style="/-dotify-defifndef:tmp_.+/"/>
                  <marker-reference marker="print-page/entry" direction="backward" scope="sequence" text-style="/-dotify-ifndef:tmp_.+/"/>
                </field>
              </footer>
            </default-template>
          </layout-master>
          <sequence master="a">
            <block>
              ⠤⠤⠤
            </block>
            <block break-before="page">
              <block>
                <marker class="print-page" value="⠤"/>
              </block>
              ⠤⠤⠤
            </block>
            <block break-before="page">
              <block>
                <marker class="print-page/prev" value="⠤"/>
                <marker class="print-page" value="⠤⠤"/>
                <marker class="running-footer" value="⠤⠤"/>
              </block>
              ⠤⠤⠤
            </block>
            <block break-before="page">
              <block>
                <marker class="print-page/prev" value="⠤⠤"/>
                <marker class="print-page" value="​"/>
                <marker class="running-header" value="⠤⠤"/>
              </block>
              ⠤⠤⠤
            </block>
            <block break-before="page">
              <block>
                <marker class="print-page/prev" value="​"/>
                <marker class="print-page" value="⠤⠤⠤"/>
                <marker class="running-footer/prev" value="⠤⠤"/>
                <marker class="running-footer" value="​"/>
              </block>
              ⠤⠤⠤
            </block>
          </sequence>
        </obfl>
      </x:document>
    </x:expect>
    <x:context label="pef">
      <x:document type="port" port="result"/>
    </x:context>
    <x:expect label="pef" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
      <x:document type="inline">
        <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
          <head xmlns:dc="http://purl.org/dc/elements/1.1/">
            <meta>
              <dc:format>application/x-pef+xml</dc:format>
            </meta>
          </head>
          <body>
            <volume rows="5" cols="20" rowgap="0" duplex="true">
              <section>
                <page>
                  <row/>
                  <row>⠤⠤⠤</row>
                </page>
                <page>
                  <row/>
                  <row>⠤⠤⠤</row>
                  <row/>
                  <row/>
                  <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠤</row>
                </page>
                <page>
                  <row/>
                  <row>⠤⠤⠤</row>
                  <row/>
                  <row/>
                  <row>⠀⠀⠀⠀⠀⠀⠀⠀⠤⠤⠀⠀⠀⠀⠀⠀⠀⠀⠤⠤</row>
                </page>
                <page>
                  <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠤⠤⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                  <row>⠤⠤⠤</row>
                  <row/>
                  <row/>
                  <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠤⠤⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                </page>
                <page>
                  <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠤⠤⠀⠀⠀⠀⠀⠀⠀⠀⠀</row>
                  <row>⠤⠤⠤</row>
                  <row/>
                  <row/>
                  <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠤⠤⠤</row>
                </page>
              </section>
            </volume>
          </body>
        </pef>
      </x:document>
    </x:expect>
  </x:scenario>
  
  <x:scenario label="test_03">
    <x:documentation>
      Tests rendering print page and running footer in bottom page margin. The print page and
      running footer strings are set in a previous section that has no page margin.
    </x:documentation>
    <x:call step="dotify:format">
      <x:input port="source">
        <x:document type="inline">
          <doc style="text-transform:none">
            <body style="@page { size: 20 5; }">
              <section style="display: block;
                              string-set: print-page '⠤', running-footer '⠤⠤'">
                ⠤⠤⠤
              </section>
              <section style="{ display: block }
                              @page {
                              size: 20 5;
                              @bottom-center { content: string(running-footer) }
                              @bottom-right { content: string(print-page) }}">
                ⠤⠤⠤
              </section>
            </body>
          </doc>
        </x:document>
      </x:input>
    </x:call>
    <x:context label="obfl">
      <x:document type="port" port="obfl"/>
    </x:context>
    <x:expect label="obfl" type="custom" href="http://www.daisy.org/pipeline/modules/braille/obfl-utils/library.xpl" step="x:obfl-compare">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false" translate="pre-translated-text-css">
          <layout-master name="a" page-width="20" page-height="5" duplex="true" page-number-variable="page">
            <default-template>
              <header/>
              <footer/>
            </default-template>
          </layout-master>
          <layout-master name="b" page-width="20" page-height="5" duplex="true" page-number-variable="page">
            <default-template>
              <header/>
              <footer>
                <field>
                  <string value=""/>
                </field>
                <field>
                  <marker-reference marker="running-footer" direction="forward" scope="page" text-style="/-dotify-def:tmp_.+/"/>
                  <marker-reference marker="running-footer" direction="backward" scope="sequence" text-style="/-dotify-defifndef:tmp_.+/"/>
                  <marker-reference marker="running-footer/entry" direction="backward" scope="sequence" text-style="/-dotify-ifndef:tmp_.+/"/>
                </field>
                <field>
                  <marker-reference marker="print-page" direction="forward" scope="page" text-style="/-dotify-def:tmp_.+/"/>
                  <marker-reference marker="print-page" direction="backward" scope="sequence" text-style="/-dotify-defifndef:tmp_.+/"/>
                  <marker-reference marker="print-page/entry" direction="backward" scope="sequence" text-style="/-dotify-ifndef:tmp_.+/"/>
                </field>
              </footer>
            </default-template>
          </layout-master>
          <sequence master="a">
            <block>
              <block>
                <marker class="print-page" value="⠤"/>
                <marker class="running-footer" value="⠤⠤"/>
              </block>
              ⠤⠤⠤
            </block>
          </sequence>
          <sequence master="b">
            <block>
              <marker class="print-page/entry" value="⠤"/>
              <marker class="running-footer/entry" value="⠤⠤"/>
            </block>
            <block>
              ⠤⠤⠤
            </block>
          </sequence>
        </obfl>
      </x:document>
    </x:expect>
    <x:context label="pef">
      <x:document type="port" port="result"/>
    </x:context>
    <x:expect label="pef" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
      <x:document type="inline">
        <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
          <head xmlns:dc="http://purl.org/dc/elements/1.1/">
            <meta>
              <dc:format>application/x-pef+xml</dc:format>
            </meta>
          </head>
          <body>
            <volume rows="5" cols="20" rowgap="0" duplex="true">
              <section>
                <page>
                  <row>⠤⠤⠤</row>
                </page>
              </section>
              <section>
                <page>
                  <row>⠤⠤⠤</row>
                  <row/>
                  <row/>
                  <row/>
                  <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠤⠤⠀⠀⠀⠀⠀⠀⠀⠀⠤</row>
                </page>
              </section>
            </volume>
          </body>
        </pef>
      </x:document>
    </x:expect>
  </x:scenario>
  
  <x:scenario label="test_04">
    <x:documentation>
      Tests counter(page) and counter-set:page. In different sections the page number is placed in
      different positions (header, footer or nowhere).
    </x:documentation>
    <x:call step="dotify:format">
      <x:input port="source">
        <x:document type="inline">
          <doc style="text-transform:none">
            <body style="@page {
                         size: 15 5;
                         @bottom-right { content: counter(page) }}">
              <section style="display: block;">
                ⠤⠤⠤
              </section>
              <section style="{ display: block } @page { size: 15 5 }">
                ⠤⠤⠤
              </section>
              <section style="display: block;
                              page-break-before: always">
                ⠤⠤⠤
              </section>
              <section style="display: block;
                              page-break-before: always;
                              counter-set: page 10">
                ⠤⠤⠤
              </section>
              <section style="display: block;
                              page-break-before: always">
                ⠤⠤⠤
              </section>
              <section style="{ display: block }
                              @page {
                              size: 15 5;
                              @top-right { content: counter(page) }}">
                ⠤⠤⠤
              </section>
            </body>
          </doc>
        </x:document>
      </x:input>
    </x:call>
    <x:context label="obfl">
      <x:document type="port" port="obfl"/>
    </x:context>
    <x:expect label="obfl" type="custom" href="http://www.daisy.org/pipeline/modules/braille/obfl-utils/library.xpl" step="x:obfl-compare">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false" translate="pre-translated-text-css">
          <layout-master name="a" page-width="15" page-height="5" duplex="true" page-number-variable="page">
            <default-template>
              <header/>
              <footer>
                <field>
                  <string value=""/>
                </field>
                <field>
                  <string value=""/>
                </field>
                <field>
                  <current-page number-format="default"/>
                </field>
              </footer>
            </default-template>
          </layout-master>
          <layout-master name="b" page-width="15" page-height="5" duplex="true" page-number-variable="page">
            <default-template>
              <header/>
              <footer/>
            </default-template>
          </layout-master>
          <layout-master name="c" page-width="15" page-height="5" duplex="true" page-number-variable="page">
            <default-template>
              <header/>
              <footer>
                <field>
                  <string value=""/>
                </field>
                <field>
                  <string value=""/>
                </field>
                <field>
                  <current-page number-format="default"/>
                </field>
              </footer>
            </default-template>
          </layout-master>
          <layout-master name="d" page-width="15" page-height="5" duplex="true" page-number-variable="page">
            <default-template>
              <header>
                <field>
                  <string value=""/>
                </field>
                <field>
                  <string value=""/>
                </field>
                <field>
                  <current-page number-format="default"/>
                </field>
              </header>
              <footer/>
            </default-template>
          </layout-master>
          <sequence master="a">
            <block>
              ⠤⠤⠤
            </block>
          </sequence>
          <sequence master="b">
            <block>
              ⠤⠤⠤
            </block>
          </sequence>
          <sequence master="a">
            <block>
              ⠤⠤⠤
            </block>
          </sequence>
          <sequence master="c" initial-page-number="10">
            <block break-before="page">
              ⠤⠤⠤
            </block>
            <block break-before="page">
              ⠤⠤⠤
            </block>
          </sequence>
          <sequence master="d">
            <block>
              ⠤⠤⠤
            </block>
          </sequence>
        </obfl>
      </x:document>
    </x:expect>
    <x:context label="pef">
      <x:document type="port" port="result"/>
    </x:context>
    <x:expect label="pef" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
      <x:document type="inline">
        <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
          <head xmlns:dc="http://purl.org/dc/elements/1.1/">
            <meta>
              <dc:format>application/x-pef+xml</dc:format>
            </meta>
          </head>
          <body>
            <volume rows="5" cols="15" rowgap="0" duplex="true">
              <section>
                <page>
                  <row>⠤⠤⠤</row>
                  <row/>
                  <row/>
                  <row/>
                  <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠼⠁</row>
                </page>
              </section>
              <section>
                <page>
                  <row>⠤⠤⠤</row>
                </page>
              </section>
              <section>
                <page>
                  <row>⠤⠤⠤</row>
                  <row/>
                  <row/>
                  <row/>
                  <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠼⠑</row>
                </page>
              </section>
              <section>
                <page>
                  <row>⠤⠤⠤</row>
                  <row/>
                  <row/>
                  <row/>
                  <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠼⠁⠚</row>
                </page>
                <page>
                  <row>⠤⠤⠤</row>
                  <row/>
                  <row/>
                  <row/>
                  <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠼⠁⠁</row>
                </page>
              </section>
              <section>
                <page>
                  <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠼⠁⠃</row>
                  <row>⠤⠤⠤</row>
                </page>
              </section>
            </volume>
          </body>
        </pef>
      </x:document>
    </x:expect>
  </x:scenario>
  
  <x:scenario label="test_05" pending="xfail doesn't work because of error">
    <x:documentation>
      Tests counter(page) with different counter styles. Broken: "Invalid input: 'i'" (roman numbers
      are not translated).
    </x:documentation>
    <x:call step="dotify:format">
      <x:input port="source">
        <x:document type="inline">
          <doc style="text-transform:none">
            <body style="@page {
                         size: 15 5;
                         @bottom-right { content: counter(page) }}">
              <frontmatter style="@page {
                                  size: 15 5;
                                  @bottom-right { content: '⠏' counter(page) }}">
                ⠤⠤⠤
              </frontmatter>
              <bodymatter>
                ⠤⠤⠤
              </bodymatter>
              <rearmatter style="{ counter-set: page 1 }
                                 @page {
                                 size: 15 5;
                                 @bottom-right { content: counter(page, lower-roman) }}">
                ⠤⠤⠤
              </rearmatter>
            </body>
          </doc>
        </x:document>
      </x:input>
    </x:call>
    <x:context label="obfl">
      <x:document type="port" port="obfl"/>
    </x:context>
    <x:expect label="obfl" type="custom" href="http://www.daisy.org/pipeline/modules/braille/obfl-utils/library.xpl" step="x:obfl-compare">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false" translate="pre-translated-text-css">
          <layout-master name="front" page-width="15" page-height="5" duplex="true" page-number-variable="page">
            <default-template>
              <header/>
              <footer>
                <field>
                  <string value=""/>
                </field>
                <field>
                  <string value=""/>
                </field>
                <field>
                  <string value="⠏"/>
                  <current-page number-format="default"/>
                </field>
              </footer>
            </default-template>
          </layout-master>
          <layout-master name="body" page-width="15" page-height="5" duplex="true" page-number-variable="page">
            <default-template>
              <header/>
              <footer>
                <field>
                  <string value=""/>
                </field>
                <field>
                  <string value=""/>
                </field>
                <field>
                  <current-page number-format="default"/>
                </field>
              </footer>
            </default-template>
          </layout-master>
          <layout-master name="rear" page-width="15" page-height="5" duplex="true" page-number-variable="page">
            <default-template>
              <header/>
              <footer>
                <field>
                  <string value=""/>
                </field>
                <field>
                  <string value=""/>
                </field>
                <field>
                  <current-page number-format="lower-roman"/>
                </field>
              </footer>
            </default-template>
          </layout-master>
          <sequence master="front">
            <block>
              ⠤⠤⠤
            </block>
          </sequence>
          <sequence master="body">
            <block>
              ⠤⠤⠤
            </block>
          </sequence>
          <sequence master="rear" initial-page-number="1">
            <block>
              ⠤⠤⠤
            </block>
          </sequence>
        </obfl>
      </x:document>
    </x:expect>
    <x:context label="pef">
      <x:document type="port" port="result"/>
    </x:context>
    <x:expect label="pef" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
      <x:document type="inline">
        <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
          <head xmlns:dc="http://purl.org/dc/elements/1.1/">
            <meta>
              <dc:format>application/x-pef+xml</dc:format>
            </meta>
          </head>
          <body>
            <volume rows="5" cols="15" rowgap="0" duplex="true">
              <section>
                <page>
                  <row>⠤⠤⠤</row>
                  <row/>
                  <row/>
                  <row/>
                  <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠏⠼⠁</row>
                </page>
              </section>
              <section>
                <page>
                  <row>⠤⠤⠤</row>
                  <row/>
                  <row/>
                  <row/>
                  <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠼⠉</row>
                </page>
              </section>
              <section>
                <page>
                  <row>⠤⠤⠤</row>
                  <row/>
                  <row/>
                  <row/>
                  <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠊</row>
                </page>
              </section>
            </volume>
          </body>
        </pef>
      </x:document>
    </x:expect>
  </x:scenario>
  
  <!--
      TODO: move orphans and widows to their own test?
  -->
  <x:scenario label="test_07">
    <x:documentation>
      Tests page-break-inside:avoid and page-break-after:avoid, both on text-only blocks and on
      blocks with nested blocks. Also tests orphans and widows.
    </x:documentation>
    <x:call step="dotify:format">
      <x:input port="source">
        <x:document type="inline">
          <doc style="text-transform:none">
            <body style="@page { size: 10 6; }">
              <section style="display: block; page-break-before: right">
                ⠤⠤⠤⠤⠤⠤⠤⠤⠤
                ⠤⠤⠤⠤⠤⠤⠤⠤⠤
                ⠤⠤⠤⠤⠤⠤⠤⠤⠤
                ⠤⠤⠤⠤⠤⠤⠤⠤⠤
                <section style="display: block">
                  ⠤⠤⠤⠤⠤⠤⠤⠤⠤
                  ⠤⠤⠤⠤⠤⠤⠤⠤⠤
                  ⠤⠤⠤⠤⠤⠤⠤⠤⠤
                  ⠤⠤⠤⠤⠤⠤⠤⠤⠤
                </section>
              </section>
              <section style="display: block; page-break-before: right">
                <p style="display: block">⠤⠤⠤</p>
                <p style="display: block">⠤⠤⠤</p>
                <p style="display: block">⠤⠤⠤</p>
                <p style="display: block">⠤⠤⠤</p>
                <section>
                  <p style="display: block">⠤⠤⠤</p>
                  <p style="display: block">⠤⠤⠤</p>
                  <p style="display: block">⠤⠤⠤</p>
                  <p style="display: block">⠤⠤⠤</p>
                </section>
              </section>
              <section style="display: block; page-break-before: right">
                ⠤⠤⠤⠤⠤⠤⠤⠤⠤
                ⠤⠤⠤⠤⠤⠤⠤⠤⠤
                ⠤⠤⠤⠤⠤⠤⠤⠤⠤
                ⠤⠤⠤⠤⠤⠤⠤⠤⠤
                <section style="display: block; page-break-inside: avoid">
                  ⠤⠤⠤⠤⠤⠤⠤⠤⠤
                  ⠤⠤⠤⠤⠤⠤⠤⠤⠤
                  ⠤⠤⠤⠤⠤⠤⠤⠤⠤
                  ⠤⠤⠤⠤⠤⠤⠤⠤⠤
                </section>
              </section>
              <section style="display: block; page-break-before: right">
                <p style="display: block">⠤⠤⠤</p>
                <p style="display: block">⠤⠤⠤</p>
                <p style="display: block">⠤⠤⠤</p>
                <p style="display: block">⠤⠤⠤</p>
                <section style="display: block; page-break-inside: avoid">
                  <p style="display: block">⠤⠤⠤</p>
                  <p style="display: block">⠤⠤⠤</p>
                  <p style="display: block">⠤⠤⠤</p>
                  <p style="display: block">⠤⠤⠤</p>
                </section>
              </section>
              <section style="display: block; page-break-before: right">
                ⠤⠤⠤⠤⠤⠤⠤⠤⠤
                ⠤⠤⠤⠤⠤⠤⠤⠤⠤
                ⠤⠤⠤⠤⠤⠤⠤⠤⠤
                ⠤⠤⠤⠤⠤⠤⠤⠤⠤
                <section style="display: block; page-break-after: avoid">
                  ⠤⠤⠤⠤⠤⠤⠤⠤⠤
                  ⠤⠤⠤⠤⠤⠤⠤⠤⠤
                </section>
                ⠤⠤⠤⠤⠤⠤⠤⠤⠤
              </section>
              <section style="display: block; page-break-before: right">
                <p style="display: block">⠤⠤⠤</p>
                <p style="display: block">⠤⠤⠤</p>
                <p style="display: block">⠤⠤⠤</p>
                <p style="display: block">⠤⠤⠤</p>
                <section style="display: block; page-break-after: avoid">
                  <p style="display: block">⠤⠤⠤</p>
                  <p style="display: block">⠤⠤⠤</p>
                </section>
                <p style="display: block">⠤⠤⠤</p>
              </section>
              <section style="display: block; page-break-before: right">
                ⠤⠤⠤⠤⠤⠤⠤⠤⠤
                ⠤⠤⠤⠤⠤⠤⠤⠤⠤
                ⠤⠤⠤⠤⠤⠤⠤⠤⠤
                ⠤⠤⠤⠤⠤⠤⠤⠤⠤
                <section style="display: block; orphans: 3">
                  ⠤⠤⠤⠤⠤⠤⠤⠤⠤
                  ⠤⠤⠤⠤⠤⠤⠤⠤⠤
                  ⠤⠤⠤⠤⠤⠤⠤⠤⠤
                  ⠤⠤⠤⠤⠤⠤⠤⠤⠤
                </section>
              </section>
              <section style="display: block; page-break-before: right">
                ⠤⠤⠤⠤⠤⠤⠤⠤⠤
                ⠤⠤⠤⠤⠤⠤⠤⠤⠤
                ⠤⠤⠤⠤⠤⠤⠤⠤⠤
                ⠤⠤⠤⠤⠤⠤⠤⠤⠤
                <section style="display: block; widows: 3">
                  ⠤⠤⠤⠤⠤⠤⠤⠤⠤
                  ⠤⠤⠤⠤⠤⠤⠤⠤⠤
                  ⠤⠤⠤⠤⠤⠤⠤⠤⠤
                  ⠤⠤⠤⠤⠤⠤⠤⠤⠤
                </section>
              </section>
            </body>
          </doc>
        </x:document>
      </x:input>
    </x:call>
    <x:context label="obfl">
      <x:document type="port" port="obfl"/>
    </x:context>
    <x:expect label="obfl" type="custom" href="http://www.daisy.org/pipeline/modules/braille/obfl-utils/library.xpl" step="x:obfl-compare">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false" translate="pre-translated-text-css">
          <layout-master name="body" page-width="10" page-height="6" duplex="true" page-number-variable="page">
            <default-template>
              <header/>
              <footer/>
            </default-template>
          </layout-master>
          <sequence master="body">
            <block>
              <block>
                ⠤⠤⠤⠤⠤⠤⠤⠤⠤
                ⠤⠤⠤⠤⠤⠤⠤⠤⠤
                ⠤⠤⠤⠤⠤⠤⠤⠤⠤
                ⠤⠤⠤⠤⠤⠤⠤⠤⠤
              </block>
              <block>
                ⠤⠤⠤⠤⠤⠤⠤⠤⠤
                ⠤⠤⠤⠤⠤⠤⠤⠤⠤
                ⠤⠤⠤⠤⠤⠤⠤⠤⠤
                ⠤⠤⠤⠤⠤⠤⠤⠤⠤
              </block>
            </block>
          </sequence>
          <sequence master="body">
            <block>
              <block>⠤⠤⠤</block>
              <block>⠤⠤⠤</block>
              <block>⠤⠤⠤</block>
              <block>⠤⠤⠤</block>
              <block>⠤⠤⠤</block>
              <block>⠤⠤⠤</block>
              <block>⠤⠤⠤</block>
              <block>⠤⠤⠤</block>
            </block>
          </sequence>
          <sequence master="body">
            <block>
              <block>
                ⠤⠤⠤⠤⠤⠤⠤⠤⠤
                ⠤⠤⠤⠤⠤⠤⠤⠤⠤
                ⠤⠤⠤⠤⠤⠤⠤⠤⠤
                ⠤⠤⠤⠤⠤⠤⠤⠤⠤
              </block>
              <block keep="page">
                ⠤⠤⠤⠤⠤⠤⠤⠤⠤
                ⠤⠤⠤⠤⠤⠤⠤⠤⠤
                ⠤⠤⠤⠤⠤⠤⠤⠤⠤
                ⠤⠤⠤⠤⠤⠤⠤⠤⠤
              </block>
            </block>
          </sequence>
          <sequence master="body">
            <block>
              <block>⠤⠤⠤</block>
              <block>⠤⠤⠤</block>
              <block>⠤⠤⠤</block>
              <block>⠤⠤⠤</block>
              <block>
                <block keep-with-next="1" keep="page">⠤⠤⠤</block>
                <block keep-with-next="1" keep="page">⠤⠤⠤</block>
                <block keep-with-next="1" keep="page">⠤⠤⠤</block>
                <block keep="page">⠤⠤⠤</block>
              </block>
            </block>
          </sequence>
          <sequence master="body">
            <block>
              <block>
                ⠤⠤⠤⠤⠤⠤⠤⠤⠤
                ⠤⠤⠤⠤⠤⠤⠤⠤⠤
                ⠤⠤⠤⠤⠤⠤⠤⠤⠤
                ⠤⠤⠤⠤⠤⠤⠤⠤⠤
              </block>
              <block keep-with-next="1" keep="page">
                ⠤⠤⠤⠤⠤⠤⠤⠤⠤
                ⠤⠤⠤⠤⠤⠤⠤⠤⠤
              </block>
              <block>
                ⠤⠤⠤⠤⠤⠤⠤⠤⠤
              </block>
            </block>
          </sequence>
          <sequence master="body">
            <block>
              <block>⠤⠤⠤</block>
              <block>⠤⠤⠤</block>
              <block>⠤⠤⠤</block>
              <block>⠤⠤⠤</block>
              <block>
                <block>⠤⠤⠤</block>
                <block keep-with-next="1" keep="page">⠤⠤⠤</block>
              </block>
              <block>⠤⠤⠤</block>
            </block>
          </sequence>
          <sequence master="body">
            <block>
              <block>
                ⠤⠤⠤⠤⠤⠤⠤⠤⠤
                ⠤⠤⠤⠤⠤⠤⠤⠤⠤
                ⠤⠤⠤⠤⠤⠤⠤⠤⠤
                ⠤⠤⠤⠤⠤⠤⠤⠤⠤
              </block>
              <block orphans="3">
                ⠤⠤⠤⠤⠤⠤⠤⠤⠤
                ⠤⠤⠤⠤⠤⠤⠤⠤⠤
                ⠤⠤⠤⠤⠤⠤⠤⠤⠤
                ⠤⠤⠤⠤⠤⠤⠤⠤⠤
              </block>
            </block>
          </sequence>
          <sequence master="body">
            <block>
              <block>
                ⠤⠤⠤⠤⠤⠤⠤⠤⠤
                ⠤⠤⠤⠤⠤⠤⠤⠤⠤
                ⠤⠤⠤⠤⠤⠤⠤⠤⠤
                ⠤⠤⠤⠤⠤⠤⠤⠤⠤
              </block>
              <block widows="3">
                ⠤⠤⠤⠤⠤⠤⠤⠤⠤
                ⠤⠤⠤⠤⠤⠤⠤⠤⠤
                ⠤⠤⠤⠤⠤⠤⠤⠤⠤
                ⠤⠤⠤⠤⠤⠤⠤⠤⠤
              </block>
            </block>
          </sequence>
        </obfl>
      </x:document>
    </x:expect>
    <x:context label="pef">
      <x:document type="port" port="result"/>
    </x:context>
    <x:expect label="pef" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
      <x:document type="inline">
        <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
          <head xmlns:dc="http://purl.org/dc/elements/1.1/">
            <meta>
              <dc:format>application/x-pef+xml</dc:format>
            </meta>
          </head>
          <body>
            <volume rows="6" cols="10" rowgap="0" duplex="true">
              <section>
                <page>
                  <row>⠤⠤⠤⠤⠤⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤⠤⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤⠤⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤⠤⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤⠤⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤⠤⠤⠤⠤⠤</row>
                </page>
                <page>
                  <row>⠤⠤⠤⠤⠤⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤⠤⠤⠤⠤⠤</row>
                </page>
              </section>
              <section>
                <page>
                  <row>⠤⠤⠤</row>
                  <row>⠤⠤⠤</row>
                  <row>⠤⠤⠤</row>
                  <row>⠤⠤⠤</row>
                  <row>⠤⠤⠤</row>
                  <row>⠤⠤⠤</row>
                </page>
                <page>
                  <row>⠤⠤⠤</row>
                  <row>⠤⠤⠤</row>
                </page>
              </section>
              <section>
                <page>
                  <row>⠤⠤⠤⠤⠤⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤⠤⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤⠤⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤⠤⠤⠤⠤⠤</row>
                </page>
                <page>
                  <row>⠤⠤⠤⠤⠤⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤⠤⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤⠤⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤⠤⠤⠤⠤⠤</row>
                </page>
              </section>
              <section>
                <page>
                  <row>⠤⠤⠤</row>
                  <row>⠤⠤⠤</row>
                  <row>⠤⠤⠤</row>
                  <row>⠤⠤⠤</row>
                </page>
                <page>
                  <row>⠤⠤⠤</row>
                  <row>⠤⠤⠤</row>
                  <row>⠤⠤⠤</row>
                  <row>⠤⠤⠤</row>
                </page>
              </section>
              <section>
                <page>
                  <row>⠤⠤⠤⠤⠤⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤⠤⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤⠤⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤⠤⠤⠤⠤⠤</row>
                </page>
                <page>
                  <row>⠤⠤⠤⠤⠤⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤⠤⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤⠤⠤⠤⠤⠤</row>
                </page>
              </section>
              <section>
                <page>
                  <row>⠤⠤⠤</row>
                  <row>⠤⠤⠤</row>
                  <row>⠤⠤⠤</row>
                  <row>⠤⠤⠤</row>
                  <row>⠤⠤⠤</row>
                </page>
                <page>
                  <row>⠤⠤⠤</row>
                  <row>⠤⠤⠤</row>
                </page>
              </section>
              <section>
                <page>
                  <row>⠤⠤⠤⠤⠤⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤⠤⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤⠤⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤⠤⠤⠤⠤⠤</row>
                </page>
                <page>
                  <row>⠤⠤⠤⠤⠤⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤⠤⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤⠤⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤⠤⠤⠤⠤⠤</row>
                </page>
              </section>
              <section>
                <page>
                  <row>⠤⠤⠤⠤⠤⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤⠤⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤⠤⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤⠤⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤⠤⠤⠤⠤⠤</row>
                </page>
                <page>
                  <row>⠤⠤⠤⠤⠤⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤⠤⠤⠤⠤⠤</row>
                  <row>⠤⠤⠤⠤⠤⠤⠤⠤⠤</row>
                </page>
              </section>
            </volume>
          </body>
        </pef>
      </x:document>
    </x:expect>
  </x:scenario>
  
  <x:scenario label="test_08">
    <x:documentation>
      Tests orphans and widows on blocks with top/bottom borders. Counting of orphan and widow lines
      does not include borders.
    </x:documentation>
    <x:call step="dotify:format">
      <x:input port="source">
        <x:document type="inline">
          <doc style="text-transform:none">
            <body style="@page { size: 10 6; }">
              <section style="display: block; page-break-before: right">
                ⠿⠿⠿⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿⠿⠿⠿
                <section style="display: block; border-top-pattern: ⠒; border-bottom-pattern: ⠒; orphans: 3">
                  ⠿⠿⠿⠿⠿⠿⠿⠿⠿
                  ⠿⠿⠿⠿⠿⠿⠿⠿⠿
                  ⠿⠿⠿⠿⠿⠿⠿⠿⠿
                  ⠿⠿⠿⠿⠿⠿⠿⠿⠿
                </section>
              </section>
              <section style="display: block; page-break-before: right">
                ⠿⠿⠿⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿⠿⠿⠿
                <section style="display: block; border-top-pattern: ⠒; border-bottom-pattern: ⠒; widows: 3">
                  ⠿⠿⠿⠿⠿⠿⠿⠿⠿
                  ⠿⠿⠿⠿⠿⠿⠿⠿⠿
                  ⠿⠿⠿⠿⠿⠿⠿⠿⠿
                  ⠿⠿⠿⠿⠿⠿⠿⠿⠿
                </section>
              </section>
            </body>
          </doc>
        </x:document>
      </x:input>
    </x:call>
    <x:context label="obfl">
      <x:document type="port" port="obfl"/>
    </x:context>
    <x:expect label="obfl" type="custom" href="http://www.daisy.org/pipeline/modules/braille/obfl-utils/library.xpl" step="x:obfl-compare">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false" translate="pre-translated-text-css">
          <layout-master name="body" page-width="10" page-height="6" duplex="true" page-number-variable="page">
            <default-template>
              <header/>
              <footer/>
            </default-template>
          </layout-master>
          <sequence master="body">
            <block>
              <block>
                ⠿⠿⠿⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿⠿⠿⠿
              </block>
              <block orphans="3"
                     border-top-style="solid"
                     border-top-align="center"
                     border-bottom-style="solid"
                     border-bottom-align="center">
                ⠿⠿⠿⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿⠿⠿⠿
              </block>
            </block>
          </sequence>
          <sequence master="body">
            <block>
              <block>
                ⠿⠿⠿⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿⠿⠿⠿
              </block>
              <block widows="3"
                     border-top-style="solid"
                     border-top-align="center"
                     border-bottom-style="solid"
                     border-bottom-align="center">
                ⠿⠿⠿⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿⠿⠿⠿
                ⠿⠿⠿⠿⠿⠿⠿⠿⠿
              </block>
            </block>
          </sequence>
        </obfl>
      </x:document>
    </x:expect>
    <x:context label="pef">
      <x:document type="port" port="result"/>
    </x:context>
    <x:expect label="pef" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
      <x:document type="inline">
        <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
          <head xmlns:dc="http://purl.org/dc/elements/1.1/">
            <meta>
              <dc:format>application/x-pef+xml</dc:format>
            </meta>
          </head>
          <body>
            <volume rows="6" cols="10" rowgap="0" duplex="true">
              <section>
                <page>
                  <row>⠿⠿⠿⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿⠿⠿⠿</row>
                </page>
                <page>
                  <row>⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒</row>
                  <row>⠿⠿⠿⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿⠿⠿⠿</row>
                  <row>⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒</row>
                </page>
              </section>
              <section>
                <page>
                  <row>⠿⠿⠿⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿⠿⠿⠿</row>
                  <row>⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒</row>
                  <row>⠿⠿⠿⠿⠿⠿⠿⠿⠿</row>
                </page>
                <page>
                  <row>⠿⠿⠿⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿⠿⠿⠿</row>
                  <row>⠒⠒⠒⠒⠒⠒⠒⠒⠒⠒</row>
                </page>
              </section>
            </volume>
          </body>
        </pef>
      </x:document>
    </x:expect>
  </x:scenario>
  
  <x:scenario label="test_09">
    <x:documentation>
      Tests page-break-after:always.
    </x:documentation>
    <x:call step="dotify:format">
      <x:input port="source">
        <x:document type="inline">
          <doc style="{ text-transform:none } @page { size: 10 6 }">
            <level1 style="display:block; page-break-after: always">
              ⠤⠤⠤
            </level1>
            <level1 style="display:block; page-break-after: always">
              ⠤⠤⠤
            </level1>
          </doc>
        </x:document>
      </x:input>
    </x:call>
    <x:context label="obfl">
      <x:document type="port" port="obfl"/>
    </x:context>
    <x:expect label="obfl" type="custom" href="http://www.daisy.org/pipeline/modules/braille/obfl-utils/library.xpl" step="x:obfl-compare">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false" translate="pre-translated-text-css">
          <layout-master name="body" page-width="10" page-height="6" duplex="true" page-number-variable="page">
            <default-template>
              <header/>
              <footer/>
            </default-template>
          </layout-master>
          <sequence master="body">
            <block> ⠤⠤⠤ </block>
            <block break-before="page"> ⠤⠤⠤ </block>
            <block break-before="page"/>
          </sequence>
        </obfl>
      </x:document>
    </x:expect>
    <x:context label="pef">
      <x:document type="port" port="result"/>
    </x:context>
    <x:expect label="pef" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
      <x:document type="inline">
        <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
          <head xmlns:dc="http://purl.org/dc/elements/1.1/">
            <meta>
              <dc:format>application/x-pef+xml</dc:format>
            </meta>
          </head>
          <body>
            <volume rows="6" cols="10" rowgap="0" duplex="true">
              <section>
                <page>
                  <row>⠤⠤⠤</row>
                </page>
                <page>
                  <row>⠤⠤⠤</row>
                </page>
                <page/>
              </section>
            </volume>
          </body>
        </pef>
      </x:document>
    </x:expect>
  </x:scenario>
  
</x:description>
