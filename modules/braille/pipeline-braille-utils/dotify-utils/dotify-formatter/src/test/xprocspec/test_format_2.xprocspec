<?xml version="1.0" encoding="UTF-8"?>
<x:description xmlns:x="http://www.daisy.org/ns/xprocspec"
               xmlns:dotify="http://code.google.com/p/dotify/"
               xmlns:p="http://www.w3.org/ns/xproc"
               xmlns:pxi="http://www.daisy.org/ns/pipeline/xproc/internal"
               xmlns:cx="http://xmlcalabash.com/ns/extensions"
               script="dotify-format.xpl">
  
  <x:scenario label="test_20">
    <x:documentation>
      Tests a table of content with target-text(), target-string(), target-counter() and
      leader().
    </x:documentation>
      <x:call step="dotify:format">
      <x:input port="source">
        <x:document type="inline">
          <doc style="text-transform:none">
            <body style="@page { size: 14 8; @bottom-right { content: counter(page) }}">
              <frontmatter>
                <toc>
                  <entry ref="chapter_1" style="display: block;
                                                content: target-text(attr(ref))
                                                         ' ⠄⠄⠄⠄⠄⠄⠄ '
                                                         target-string(attr(ref), print-page)
                                                         ' '
                                                         target-counter(attr(ref), page)"/>
                  <entry ref="chapter_2" style="display: block;
                                                content: target-text(attr(ref))
                                                         ' ⠄⠄⠄⠄⠄⠄ '
                                                         target-string(attr(ref), print-page)
                                                         ' '
                                                         target-counter(attr(ref), page)"/>
                  <entry ref="chapter_3" style="display: block;
                                                content: target-text(attr(ref))
                                                         ' ⠄⠄⠄⠄ '
                                                         target-string(attr(ref), print-page)
                                                         ' '
                                                         target-counter(attr(ref), page)"/>
                </toc>
              </frontmatter>
              <bodymatter>
                <pagenum style="display:none;string-set:print-page '⠤'"/>
                <h id="chapter_1" style="display:block;text-align:center;page-break-before:always">⠿</h>
                <p style="display:block">⠤⠤⠤</p>
                <h id="chapter_2" style="display:block;text-align:center;page-break-before:always">⠿⠿</h>
                <p style="display:block">⠤⠤⠤</p>
                <pagenum style="display:none;string-set:print-page '⠤⠤'"/>
                <h id="chapter_3" style="display:block;text-align:center;page-break-before:always">⠿⠿⠿</h>
                <p style="display:block">⠤⠤⠤</p>
              </bodymatter>
            </body>
          </doc>
        </x:document>
      </x:input>
    </x:call>
    <x:context label="obfl">
      <x:document type="port" port="obfl"/>
    </x:context>
    <x:expect label="obfl" type="custom" href="http://www.daisy.org/pipeline/modules/braille/obfl-utils/library.xpl" step="x:obfl-compare">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false" translate="pre-translated-text-css">
          <layout-master name="body" page-width="14" page-height="8" duplex="true" page-number-variable="page">
            <default-template>
              <header/>
              <footer>
                <field>
                  <string value=""/>
                </field>
                <field>
                  <string value=""/>
                </field>
                <field>
                  <current-page number-format="default"/>
                </field>
              </footer>
            </default-template>
          </layout-master>
          <sequence master="body">
            <block>
              ⠿
              ⠄⠄⠄⠄⠄⠄⠄
              ⠤
              <page-number ref-id="chapter_1" number-format="default"/>
            </block>
            <block>
              ⠿⠿
              ⠄⠄⠄⠄⠄⠄
              ⠤
              <page-number ref-id="chapter_2" number-format="default"/>
            </block>
            <block>
              ⠿⠿⠿
              ⠄⠄⠄⠄
              ⠤⠤
              <page-number ref-id="chapter_3" number-format="default"/>
            </block>
            <block align="center" break-before="page" id="chapter_1">
              <block>
                <marker class="print-page" value="⠤"/>
              </block>
              ⠿
            </block>
            <block>
              ⠤⠤⠤
            </block>
            <block align="center" break-before="page" id="chapter_2">
              ⠿⠿
            </block>
            <block>
              ⠤⠤⠤
            </block>
            <block align="center" break-before="page" id="chapter_3">
              <block>
                <marker class="print-page/prev" value="⠤"/>
                <marker class="print-page" value="⠤⠤"/>
              </block>
              ⠿⠿⠿
            </block>
            <block>
              ⠤⠤⠤
            </block>
          </sequence>
        </obfl>
      </x:document>
    </x:expect>
    <x:context label="pef">
      <x:document type="port" port="result"/>
    </x:context>
    <x:expect label="pef" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
      <x:document type="inline">
        <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
          <head xmlns:dc="http://purl.org/dc/elements/1.1/">
            <meta>
              <dc:format>application/x-pef+xml</dc:format>
            </meta>
          </head>
          <body>
            <volume rows="8" cols="14" rowgap="0" duplex="true">
              <section>
                <page>
                  <row>⠿⠀⠄⠄⠄⠄⠄⠄⠄⠀⠤⠀⠼⠃</row>
                  <row>⠿⠿⠀⠄⠄⠄⠄⠄⠄⠀⠤⠀⠼⠉</row>
                  <row>⠿⠿⠿⠀⠄⠄⠄⠄⠀⠤⠤⠀⠼⠙</row>
                  <row/>
                  <row/>
                  <row/>
                  <row/>
                  <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠼⠁</row>
                </page>
                <page>
                  <row>⠀⠀⠀⠀⠀⠀⠿</row>
                  <row>⠤⠤⠤</row>
                  <row/>
                  <row/>
                  <row/>
                  <row/>
                  <row/>
                  <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠼⠃</row>
                </page>
                <page>
                  <row>⠀⠀⠀⠀⠀⠀⠿⠿</row>
                  <row>⠤⠤⠤</row>
                  <row/>
                  <row/>
                  <row/>
                  <row/>
                  <row/>
                  <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠼⠉</row>
                </page>
                <page>
                  <row>⠀⠀⠀⠀⠀⠿⠿⠿</row>
                  <row>⠤⠤⠤</row>
                  <row/>
                  <row/>
                  <row/>
                  <row/>
                  <row/>
                  <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠼⠙</row>
                </page>
              </section>
            </volume>
          </body>
        </pef>
      </x:document>
    </x:expect>
  </x:scenario>
  
  <x:scenario label="test_21">
    <x:documentation>
      Tests target-text() and target-counter() with both forward references (table of contents in
      the front) and backward references (index in the back).
    </x:documentation>
    <x:call step="dotify:format">
      <x:input port="source">
        <x:document type="inline">
          <doc style="text-transform:none">
            <body style="@page { size: 15 5; @bottom-right { content: counter(page) }}">
              <frontmatter>
                <toc>
                  <entry ref="chapter_1" style="display: block;
                                                content: target-text(attr(ref))
                                                         ' ⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄ '
                                                         target-counter(attr(ref), page)"/>
                  <entry ref="chapter_2" style="display: block;
                                                content: target-text(attr(ref))
                                                         ' ⠄⠄⠄⠄⠄⠄⠄⠄⠄ '
                                                         target-counter(attr(ref), page)"/>
                </toc>
              </frontmatter>
              <bodymatter style="display:block;page-break-before:always">
                <h style="display:block" id="chapter_1">⠿</h>
                <p style="display:block" id="x">⠤⠤⠤</p>
                <h style="display:block" id="chapter_2">⠿⠿</h>
                <p style="display:block" id="y">⠤⠤⠤</p>
                <p style="display:block" id="z">⠤⠤⠤</p>
              </bodymatter>
              <rearmatter style="display:block;page-break-before:always">
                <index>
                  <entry ref="x" style="display: block;
                                        content: target-text(attr(ref))
                                                 ' ⠄⠄⠄⠄⠄⠄⠄⠄ '
                                                 target-counter(attr(ref), page)"/>
                  <entry ref="y" style="display: block;
                                        content: target-text(attr(ref))
                                                 ' ⠄⠄⠄⠄⠄⠄⠄⠄ '
                                                 target-counter(attr(ref), page)"/>
                  <entry ref="z" style="display: block;
                                        content: target-text(attr(ref))
                                                 ' ⠄⠄⠄⠄⠄⠄⠄⠄ '
                                                 target-counter(attr(ref), page)"/>
                </index>
              </rearmatter>
            </body>
          </doc>
        </x:document>
      </x:input>
    </x:call>
    <x:context label="obfl">
      <x:document type="port" port="obfl"/>
    </x:context>
    <x:expect label="obfl" type="custom" href="http://www.daisy.org/pipeline/modules/braille/obfl-utils/library.xpl" step="x:obfl-compare">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false" translate="pre-translated-text-css">
          <layout-master name="body" page-width="15" page-height="5" duplex="true" page-number-variable="page">
            <default-template>
              <header/>
              <footer>
                <field>
                  <string value=""/>
                </field>
                <field>
                  <string value=""/>
                </field>
                <field>
                  <current-page number-format="default"/>
                </field>
              </footer>
            </default-template>
          </layout-master>
          <sequence master="body">
            <block>
              ⠿
              ⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄
              <page-number ref-id="chapter_1" number-format="default"/>
            </block>
            <block>
              ⠿⠿
              ⠄⠄⠄⠄⠄⠄⠄⠄⠄
              <page-number ref-id="chapter_2" number-format="default"/>
            </block>
            <block break-before="page">
              <block id="chapter_1">
                ⠿
              </block>
              <block id="x">
                ⠤⠤⠤
              </block>
              <block id="chapter_2">
                ⠿⠿
              </block>
              <block id="y">
                ⠤⠤⠤
              </block>
              <block id="z">
                ⠤⠤⠤
              </block>
            </block>
            <block break-before="page">
              <block>
                ⠤⠤⠤
                ⠄⠄⠄⠄⠄⠄⠄⠄
                <page-number ref-id="x" number-format="default"/>
              </block>
              <block>
                ⠤⠤⠤
                ⠄⠄⠄⠄⠄⠄⠄⠄
                <page-number ref-id="y" number-format="default"/>
              </block>
              <block>
                ⠤⠤⠤
                ⠄⠄⠄⠄⠄⠄⠄⠄
                <page-number ref-id="z" number-format="default"/>
              </block>
            </block>
          </sequence>
        </obfl>
      </x:document>
    </x:expect>
    <x:context label="pef">
      <x:document type="port" port="result"/>
    </x:context>
    <x:expect label="pef" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
      <x:document type="inline">
        <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
          <head xmlns:dc="http://purl.org/dc/elements/1.1/">
            <meta>
              <dc:format>application/x-pef+xml</dc:format>
            </meta>
          </head>
          <body>
            <volume rows="5" cols="15" rowgap="0" duplex="true">
              <section>
                <page>
                  <row>⠿⠀⠄⠄⠄⠄⠄⠄⠄⠄⠄⠄⠀⠼⠃</row>
                  <row>⠿⠿⠀⠄⠄⠄⠄⠄⠄⠄⠄⠄⠀⠼⠃</row>
                  <row/>
                  <row/>
                  <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠼⠁</row>
                </page>
                <page>
                  <row>⠿</row>
                  <row>⠤⠤⠤</row>
                  <row>⠿⠿</row>
                  <row>⠤⠤⠤</row>
                  <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠼⠃</row>
                </page>
                <page>
                  <row>⠤⠤⠤</row>
                  <row/>
                  <row/>
                  <row/>
                  <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠼⠉</row>
                </page>
                <page>
                  <row>⠤⠤⠤⠀⠄⠄⠄⠄⠄⠄⠄⠄⠀⠼⠃</row>
                  <row>⠤⠤⠤⠀⠄⠄⠄⠄⠄⠄⠄⠄⠀⠼⠃</row>
                  <row>⠤⠤⠤⠀⠄⠄⠄⠄⠄⠄⠄⠄⠀⠼⠉</row>
                  <row/>
                  <row>⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠼⠙</row>
                </page>
              </section>
            </volume>
          </body>
        </pef>
      </x:document>
    </x:expect>
  </x:scenario>
  
  <x:scenario label="test_22" pending="xfail doesn't work because of error">
    <x:documentation>
      Tests target-counter() referencing inline element.
      
      Broken: "Failed to complete volume division": is this a Dotify bug?
    </x:documentation>
    <x:call step="dotify:format">
      <x:input port="source">
        <x:document type="inline">
          <doc style="{ text-transform:none } @page { size: 14 8 }">
            <p style="display:block">
              <a href="foo" style="::after { content: target-counter(attr(href), page) }"/>
            </p>
            <p style="display:block">
              ⠤⠤⠤⠤
              <a id="foo">
                ⠿
              </a>
            </p>
            <p style="display:block">
              ⠤⠤⠤⠤
            </p>
          </doc>
        </x:document>
      </x:input>
    </x:call>
    <x:context label="obfl">
      <x:document type="port" port="obfl"/>
    </x:context>
    <x:expect label="obfl" type="custom" href="http://www.daisy.org/pipeline/modules/braille/obfl-utils/library.xpl" step="x:obfl-compare">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false" translate="pre-translated-text-css">
          <layout-master name="body" page-width="14" page-height="8" duplex="true" page-number-variable="page">
            <default-template>
              <header/>
              <footer/>
            </default-template>
          </layout-master>
          <sequence master="body">
            <block>
              <page-number ref-id="foo" number-format="default"/>
            </block>
            <block>
              ⠤⠤⠤⠤
              <span id="foo">
                ⠿
              </span>
            </block>
            <block>
              ⠤⠤⠤⠤
            </block>
          </sequence>
        </obfl>
      </x:document>
    </x:expect>
    <x:context label="pef">
      <x:document type="port" port="result"/>
    </x:context>
    <x:expect label="pef" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
      <x:document type="inline">
        <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
          <head xmlns:dc="http://purl.org/dc/elements/1.1/">
            <meta>
              <dc:format>application/x-pef+xml</dc:format>
            </meta>
          </head>
          <body>
            <volume rows="8" cols="14" rowgap="0" duplex="true">
              <section>
                <page>
                  <row>⠼⠁</row>
                  <row>⠤⠤⠤⠤⠀⠿</row>
                  <row>⠤⠤⠤⠤</row>
                </page>
              </section>
            </volume>
          </body>
        </pef>
      </x:document>
    </x:expect>
  </x:scenario>
  
  <x:scenario label="test_23">
    <x:documentation>
      Tests generated newline (&#xA;) and white-space:pre-line.
    </x:documentation>
    <x:call step="dotify:format">
      <x:input port="source">
        <x:document type="inline">
          <doc style="text-transform:none; display:block">
            ⠤⠤⠤<br style="::before { content: '&#xA;'; white-space: pre-line; }"/>⠤⠤⠤
          </doc>
        </x:document>
      </x:input>
    </x:call>
    <x:context label="obfl">
      <x:document type="port" port="obfl"/>
    </x:context>
    <x:expect label="obfl" type="custom" href="http://www.daisy.org/pipeline/modules/braille/obfl-utils/library.xpl" step="x:obfl-compare">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false" translate="pre-translated-text-css">
          <layout-master name="a" page-width="40" page-height="25" duplex="true" page-number-variable="page">
            <default-template>
              <header/>
              <footer/>
            </default-template>
          </layout-master>
          <sequence master="a">
            <block>
              ⠤⠤⠤&#x200B;<br/>⠤⠤⠤
            </block>
          </sequence>
        </obfl>
      </x:document>
    </x:expect>
    <x:context label="pef">
      <x:document type="port" port="result"/>
    </x:context>
    <x:expect label="pef" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
      <x:document type="inline">
        <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
          <head xmlns:dc="http://purl.org/dc/elements/1.1/">
            <meta>
              <dc:format>application/x-pef+xml</dc:format>
            </meta>
          </head>
          <body>
            <volume rows="25" cols="40" rowgap="0" duplex="true">
              <section>
                <page>
                  <row>⠤⠤⠤</row>
                  <row>⠤⠤⠤</row>
                </page>
              </section>
            </volume>
          </body>
        </pef>
      </x:document>
    </x:expect>
  </x:scenario>
  
  <x:scenario label="test_24">
    <x:documentation>
      Tests -obfl-vertical-position and -obfl-vertical-align:before.
    </x:documentation>
    <x:call step="dotify:format">
      <x:input port="source">
        <x:document type="inline">
          <doc style="text-transform:none">
            <div style="display: block; -obfl-vertical-align: before; -obfl-vertical-position: 5">
              ⠤⠤⠤
            </div>
          </doc>
        </x:document>
      </x:input>
    </x:call>
    <x:context label="obfl">
      <x:document type="port" port="obfl"/>
    </x:context>
    <x:expect label="obfl" type="custom" href="http://www.daisy.org/pipeline/modules/braille/obfl-utils/library.xpl" step="x:obfl-compare">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false" translate="pre-translated-text-css">
          <layout-master name="a" page-width="40" page-height="25" duplex="true" page-number-variable="page">
            <default-template>
              <header/>
              <footer/>
            </default-template>
          </layout-master>
          <sequence master="a">
            <block vertical-align="before" vertical-position="5">
              ⠤⠤⠤
            </block>
          </sequence>
        </obfl>
      </x:document>
    </x:expect>
    <x:context label="pef">
      <x:document type="port" port="result"/>
    </x:context>
    <x:expect label="pef" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
      <x:document type="inline">
        <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
          <head xmlns:dc="http://purl.org/dc/elements/1.1/">
            <meta>
              <dc:format>application/x-pef+xml</dc:format>
            </meta>
          </head>
          <body>
            <volume cols="40" rows="25" rowgap="0" duplex="true">
              <section>
                <page>
                  <row/>
                  <row/>
                  <row/>
                  <row/>
                  <row>⠤⠤⠤</row>
                </page>
              </section>
            </volume>
          </body>
        </pef>
      </x:document>
    </x:expect>
  </x:scenario>
  
  <x:scenario label="test_25">
    <x:documentation>
      Tests (pre-)hyphenation.
    </x:documentation>
    <x:call step="dotify:format">
      <x:input port="source">
        <x:document type="inline">
          <doc style="{ text-transform:none; display:block } @page { size: 12 5; }">
            ⠿⠿⠿⠿⠿⠿ ⠿⠿⠿­⠿⠿⠿ ⠿⠿⠿⠿⠿⠿
          </doc>
        </x:document>
      </x:input>
    </x:call>
    <x:context label="obfl">
      <x:document type="port" port="obfl"/>
    </x:context>
    <x:expect label="obfl" type="custom" href="http://www.daisy.org/pipeline/modules/braille/obfl-utils/library.xpl" step="x:obfl-compare">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false" translate="pre-translated-text-css">
          <layout-master name="a" page-width="12" page-height="5" duplex="true" page-number-variable="page">
            <default-template>
              <header/>
              <footer/>
            </default-template>
          </layout-master>
          <sequence master="a">
            <block >
              ⠿⠿⠿⠿⠿⠿ ⠿⠿⠿­⠿⠿⠿ ⠿⠿⠿⠿⠿⠿
            </block>
          </sequence>
        </obfl>
      </x:document>
    </x:expect>
    <x:context label="pef">
      <x:document type="port" port="result"/>
    </x:context>
    <x:expect label="pef" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
      <x:document type="inline">
        <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
          <head xmlns:dc="http://purl.org/dc/elements/1.1/">
            <meta>
              <dc:format>application/x-pef+xml</dc:format>
            </meta>
          </head>
          <body>
            <volume cols="12" rows="5" rowgap="0" duplex="true">
              <section>
                <page>
                  <row>⠿⠿⠿⠿⠿⠿⠀⠿⠿⠿⠤</row>
                  <row>⠿⠿⠿⠀⠿⠿⠿⠿⠿⠿</row>
                </page>
              </section>
            </volume>
          </body>
        </pef>
      </x:document>
    </x:expect>
  </x:scenario>
  
  <x:scenario label="test_26">
    <x:documentation>
      Tests collapsing of margins of adjacent sibling blocks, and non-collapsing of padding.
    </x:documentation>
    <x:call step="dotify:format">
      <x:input port="source">
        <x:document type="inline">
          <doc style="text-transform:none">
            <body style="@page { size: 20 15 }">
              <div style="display: block; margin-bottom: 1">
                ⠿⠿⠿⠿
              </div>
              <div style="display: block; margin-top: 1; margin-bottom: 1">
                ⠿⠿⠿⠿
              </div>
              <div style="display: block; padding-top: 1">
                ⠿⠿⠿⠿
              </div>
            </body>
          </doc>
        </x:document>
      </x:input>
    </x:call>
    <x:context label="obfl">
      <x:document type="port" port="obfl"/>
    </x:context>
    <x:expect label="obfl" type="custom" href="http://www.daisy.org/pipeline/modules/braille/obfl-utils/library.xpl" step="x:obfl-compare">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false" translate="pre-translated-text-css">
          <layout-master name="body" page-width="20" page-height="15" duplex="true" page-number-variable="page">
            <default-template>
              <header/>
              <footer/>
            </default-template>
          </layout-master>
          <sequence master="body">
            <block margin-bottom="1">
              ⠿⠿⠿⠿
            </block>
            <block margin-top="1" margin-bottom="1">
              ⠿⠿⠿⠿
            </block>
            <block padding-top="1">
              ⠿⠿⠿⠿
            </block>
          </sequence>
        </obfl>
      </x:document>
    </x:expect>
    <x:context label="pef">
      <x:document type="port" port="result"/>
    </x:context>
    <x:expect label="pef" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
      <x:document type="inline">
        <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
          <head xmlns:dc="http://purl.org/dc/elements/1.1/">
            <meta>
              <dc:format>application/x-pef+xml</dc:format>
            </meta>
          </head>
          <body>
            <volume rows="15" cols="20" rowgap="0" duplex="true">
              <section>
                <page>
                  <row>⠿⠿⠿⠿</row>
                  <row/>
                  <row>⠿⠿⠿⠿</row>
                  <row/>
                  <row/>
                  <row>⠿⠿⠿⠿</row>
                </page>
              </section>
            </volume>
          </body>
        </pef>
      </x:document>
    </x:expect>
  </x:scenario>
  
  <x:scenario label="test_27">
    <x:documentation>
      Tests collapsing of margins of three adjacent sibling blocks, the middle one being empty. The
      middle one is said to "collapse through".
    </x:documentation>
    <x:call step="dotify:format">
      <x:input port="source">
        <x:document type="inline">
          <doc style="text-transform:none">
            <p style="display:block; margin-bottom:1"> ⠿ </p>
            <p style="display:block; margin-bottom:1"/>
            <p style="display:block; margin-top:1"> ⠿ </p>
          </doc>
        </x:document>
      </x:input>
    </x:call>
    <x:context label="obfl">
      <x:document type="port" port="obfl"/>
    </x:context>
    <x:expect label="obfl" type="custom" href="http://www.daisy.org/pipeline/modules/braille/obfl-utils/library.xpl" step="x:obfl-compare">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false" translate="pre-translated-text-css">
          <layout-master name="a" page-width="40" page-height="25" duplex="true" page-number-variable="page">
            <default-template>
              <header/>
              <footer/>
            </default-template>
          </layout-master>
          <sequence master="a">
            <block margin-bottom="1"> ⠿ </block>
            <block margin-bottom="1"/>
            <block margin-top="1"> ⠿ </block>
          </sequence>
        </obfl>
      </x:document>
    </x:expect>
    <x:context label="pef">
      <x:document type="port" port="result"/>
    </x:context>
    <x:expect label="pef" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
      <x:document type="inline">
        <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
          <head xmlns:dc="http://purl.org/dc/elements/1.1/">
            <meta>
              <dc:format>application/x-pef+xml</dc:format>
            </meta>
          </head>
          <body>
            <volume rows="25" cols="40" rowgap="0" duplex="true">
              <section>
                <page>
                  <row>⠿</row>
                  <row/>
                  <row>⠿</row>
                </page>
              </section>
            </volume>
          </body>
        </pef>
      </x:document>
    </x:expect>
  </x:scenario>
  
  <x:scenario label="test_28">
    <x:documentation>
      Tests line-height:2 on blocks.
    </x:documentation>
    <x:call step="dotify:format">
      <x:input port="source">
        <x:document type="inline">
          <doc style="{ text-transform:none } @page { size: 40 25 }">
            <body>
              <p style="display: block; line-height: 2">
                ⠿⠿⠿⠿⠿⠿⠿⠿ ⠿⠿⠿⠿⠿⠿⠿⠿
              </p>
              <p style="display: block; line-height: 2">
                ⠿⠿⠿⠿⠿⠿⠿⠿ ⠿⠿⠿⠿⠿⠿⠿⠿
              </p>
              <p style="display: block; line-height: 2">
                ⠿⠿⠿⠿⠿⠿⠿⠿ ⠿⠿⠿⠿⠿⠿⠿⠿
              </p>
              <p style="display: block; line-height: 2">
                ⠿⠿⠿⠿⠿⠿⠿⠿ ⠿⠿⠿⠿⠿⠿⠿⠿
              </p>
            </body>
          </doc>
        </x:document>
      </x:input>
    </x:call>
    <x:context label="obfl">
      <x:document type="port" port="obfl"/>
    </x:context>
    <x:expect label="obfl" type="custom" href="http://www.daisy.org/pipeline/modules/braille/obfl-utils/library.xpl" step="x:obfl-compare">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false" translate="pre-translated-text-css">
          <layout-master name="a" page-width="40" page-height="25" duplex="true" page-number-variable="page">
            <default-template>
              <header/>
              <footer/>
            </default-template>
          </layout-master>
          <sequence master="a">
            <block row-spacing="2.0">⠿⠿⠿⠿⠿⠿⠿⠿ ⠿⠿⠿⠿⠿⠿⠿⠿</block>
            <block row-spacing="2.0">⠿⠿⠿⠿⠿⠿⠿⠿ ⠿⠿⠿⠿⠿⠿⠿⠿</block>
            <block row-spacing="2.0">⠿⠿⠿⠿⠿⠿⠿⠿ ⠿⠿⠿⠿⠿⠿⠿⠿</block>
            <block row-spacing="2.0">⠿⠿⠿⠿⠿⠿⠿⠿ ⠿⠿⠿⠿⠿⠿⠿⠿</block>
          </sequence>
        </obfl>
      </x:document>
    </x:expect>
    <x:context label="pef">
      <x:document type="port" port="result"/>
    </x:context>
    <x:expect label="pef" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
      <x:document type="inline">
        <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
          <head xmlns:dc="http://purl.org/dc/elements/1.1/">
            <meta>
              <dc:format>application/x-pef+xml</dc:format>
            </meta>
          </head>
          <body>
            <volume rows="25" cols="40" rowgap="0" duplex="true">
              <section>
                <page>
                  <row rowgap="4">⠿⠿⠿⠿⠿⠿⠿⠿⠀⠿⠿⠿⠿⠿⠿⠿⠿</row>
                  <row rowgap="4">⠿⠿⠿⠿⠿⠿⠿⠿⠀⠿⠿⠿⠿⠿⠿⠿⠿</row>
                  <row rowgap="4">⠿⠿⠿⠿⠿⠿⠿⠿⠀⠿⠿⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿⠿⠿⠀⠿⠿⠿⠿⠿⠿⠿⠿</row>
                </page>
              </section>
            </volume>
          </body>
        </pef>
      </x:document>
    </x:expect>
  </x:scenario>
  
  <x:scenario label="test_29">
    <x:documentation>
      Tests line-height:2 on root element.
    </x:documentation>
    <x:call step="dotify:format">
      <x:input port="source">
        <x:document type="inline">
          <doc style="text-transform:none; line-height:2">
            <body>
              <p style="display:block">
                ⠿⠿⠿⠿⠿⠿⠿⠿ ⠿⠿⠿⠿⠿⠿⠿⠿
              </p>
              <p style="display:block">
                ⠿⠿⠿⠿⠿⠿⠿⠿ ⠿⠿⠿⠿⠿⠿⠿⠿
              </p>
              <p style="display:block">
                ⠿⠿⠿⠿⠿⠿⠿⠿ ⠿⠿⠿⠿⠿⠿⠿⠿
              </p>
              <p style="display:block">
                ⠿⠿⠿⠿⠿⠿⠿⠿ ⠿⠿⠿⠿⠿⠿⠿⠿
              </p>
              </body>
          </doc>
        </x:document>
      </x:input>
    </x:call>
    <x:context label="obfl">
      <x:document type="port" port="obfl"/>
    </x:context>
    <x:expect label="obfl" type="custom" href="http://www.daisy.org/pipeline/modules/braille/obfl-utils/library.xpl" step="x:obfl-compare">
      <x:document type="inline">
        <obfl xmlns="http://www.daisy.org/ns/2011/obfl" version="2011-1" xml:lang="und" hyphenate="false" translate="pre-translated-text-css">
          <layout-master name="a" page-width="40" page-height="25" duplex="true" page-number-variable="page">
            <default-template>
              <header/>
              <footer/>
            </default-template>
          </layout-master>
          <sequence master="a">
            <block row-spacing="2.0">⠿⠿⠿⠿⠿⠿⠿⠿ ⠿⠿⠿⠿⠿⠿⠿⠿</block>
            <block row-spacing="2.0">⠿⠿⠿⠿⠿⠿⠿⠿ ⠿⠿⠿⠿⠿⠿⠿⠿</block>
            <block row-spacing="2.0">⠿⠿⠿⠿⠿⠿⠿⠿ ⠿⠿⠿⠿⠿⠿⠿⠿</block>
            <block row-spacing="2.0">⠿⠿⠿⠿⠿⠿⠿⠿ ⠿⠿⠿⠿⠿⠿⠿⠿</block>
          </sequence>
        </obfl>
      </x:document>
    </x:expect>
    <x:context label="pef">
      <x:document type="port" port="result"/>
    </x:context>
    <x:expect label="pef" type="custom" href="http://www.daisy.org/pipeline/modules/braille/pef-utils/library.xpl" step="x:pef-compare">
      <x:document type="inline">
        <pef xmlns="http://www.daisy.org/ns/2008/pef" version="2008-1">
          <head xmlns:dc="http://purl.org/dc/elements/1.1/">
            <meta>
              <dc:format>application/x-pef+xml</dc:format>
            </meta>
          </head>
          <body>
            <volume rows="25" cols="40" rowgap="0" duplex="true">
              <section>
                <page>
                  <row rowgap="4">⠿⠿⠿⠿⠿⠿⠿⠿⠀⠿⠿⠿⠿⠿⠿⠿⠿</row>
                  <row rowgap="4">⠿⠿⠿⠿⠿⠿⠿⠿⠀⠿⠿⠿⠿⠿⠿⠿⠿</row>
                  <row rowgap="4">⠿⠿⠿⠿⠿⠿⠿⠿⠀⠿⠿⠿⠿⠿⠿⠿⠿</row>
                  <row>⠿⠿⠿⠿⠿⠿⠿⠿⠀⠿⠿⠿⠿⠿⠿⠿⠿</row>
                </page>
              </section>
            </volume>
          </body>
        </pef>
      </x:document>
    </x:expect>
  </x:scenario>
  
</x:description>
