@namespace epub 'http://www.idpf.org/2007/ops';
@namespace xml 'http://www.w3.org/XML/1998/namespace';

/* Declare parameters. Values are passed in from nlb:dtbook-to-pef. */
$show-print-page-numbers: false !default;
$show-braille-page-numbers: false !default;
$line-spacing: false !default;
$include-note-references: true !default;
$choice-of-colophon: true !default;

/* -------------------------------------------------------------------------- */
/*                page                                                        */
/* -------------------------------------------------------------------------- */

@page {
        margin-top: 0;
        margin-bottom: 1;
        margin-left: 2;
        margin-right: 2;
}

bodymatter, body:not([epub|type~='cover']):not([epub|type~='frontmatter']):not([epub|type~='backmatter']) {
        page: body;
        counter-set: page 1;
}

/* -------------------------------------------------------------------------- */
/*                braille and print page numbers                              */
/* -------------------------------------------------------------------------- */

/* Don't show pagenumber inline. Store reference in case we want to show marker in margin. */
pagenum, *[epub|type~='pagebreak'] {
        display: none;
        -obfl-marker: pagenum;
}

/* Show page numbers in bodymatter. */
@if $show-print-page-numbers {
        bodymatter pagenum {
                string-set: print-page "⠿" content();
        }
        
        body:not([epub|type~='cover']):not([epub|type~='frontmatter']):not([epub|type~='backmatter']) *[epub|type~='pagebreak'] {
                &[title] {
                        string-set: print-page "⠿" attr(title);
                }
                &:not([title]) {
                        string-set: print-page "⠿" content();
                }
        }
}

@page body {
        @if $show-print-page-numbers {
                @bottom-right {
                        content: string(print-page, last);
                }
                @left {
                    content: -obfl-marker-indicator(pagenum, '⠿');
                }
        }

        @if $show-braille-page-numbers {
                @bottom-center {
                        content: counter(page);
                }
        }
}

/* -------------------------------------------------------------------------- */
/*               line spacing                                                 */
/* -------------------------------------------------------------------------- */

@if $line-spacing == double {
        :root {
                line-height: 1;

                /* to cancel out generic rule */
        }

        bodymatter, body:not([epub|type~='cover']):not([epub|type~='frontmatter']):not([epub|type~='backmatter']) {
                line-height: 2;
        }

        @page body:left {
                margin-top: 1;
        }
}

/* -------------------------------------------------------------------------- */
/*               for volume breaking, toc, titlepage                          */
/* -------------------------------------------------------------------------- */

/* Always start a new volume before a part */
level1.part,
*[epub|type~='part'] {
        volume-break-before: always;
}

/* Avoid breaking inside chapters in parts */
level1.part > level2,
*[epub|type~='part'] > section,
*[epub|type~='part'] > article,
*[epub|type~='part'] > main,
*[epub|type~='part'] > *:has(h1),
*[epub|type~='part'] > *:has(h2),
*[epub|type~='part'] > *:has(h3) {
        volume-break-inside: -obfl-keep(8);
}

/* Insert generated content at start of volume */
@volume {
        @begin {
                content: flow(front) flow(volume-toc);
        }
}

level1.first-page, section.first-page {
        flow: front;
}

.titlepage {
        display: block;
        page-break-before: always;
        flow: titlepage;
}

@if $choice-of-colophon {
        .colophon {
                display: block;
                page-break-before: always;
                flow: titlepage;
        }
}

#generated-volume-toc {
        page-break-before: always;
}

#generated-volume-toc li {
        display: block;
        margin-left: 2;
        margin-top: 2;
        text-indent: -2;
}

#generated-volume-toc li a::after {
        content: " " leader("⠄") " " target-counter(attr(href), page);
        margin-left: 2;
        margin-top: 2;
        text-indent: -2;
}

/* -------------------------------------------------------------------------- */
/*                        Generated content CSS                               */
/* -------------------------------------------------------------------------- */
.first-page {
        flow: front;
}

.first-page p {
        text-align: center;
}

.first-page p, .second-page p, .third-page p {
        display: block;
}

.author-1 {
        margin-top: 3;
}

.translator {
        margin-top: 2;
}

.title-pef {
        display: block;
        margin-top: 1;
}

.nlb {
        margin-top: 4;
}

.year {}

.bind::before {
        display: inline;
        content: "Bind " -obfl-evaluate("(round $volume)");
}

.bind {
        display: inline;
        -obfl-vertical-position: 25;
}

.bind::after {
        display: inline;
        content: -obfl-evaluate("(round $volumes)");
        page-break-after: always;
}

.second-page h1, third-page h1 {
        display: block;
        page-break-before: always;
}

.contraction-level {
        margin-top: 1;
}

.contact {
        page-break-after: always;
}

/* -------------------------------------------------------------------------- */
/*                                  Pages in document                         */
/* -------------------------------------------------------------------------- */
.second-page, .third-page {
        flow: front-first;
}

@volume :first {
        @begin {
                content: flow(front) flow(volume-toc) flow(front-first);
        }
}

.pages {
        display: inline;
}

.pages::after {
        display: inline;
        content: -obfl-evaluate("(round $sheets-in-document)");
}

/* -------------------------------------------------------------------------- */
/*                                  general                                   */
/* -------------------------------------------------------------------------- */
head {
        display: none;
}

level1,
bodymatter, rearmatter, body:not([epub|type~='cover']):not([epub|type~='frontmatter']) {
        display: block;
}

frontmatter, *[epub|type~='frontmatter'] {
        display: none;
        &:has(> *:not(doctitle,
                      h1[epub|type~='fulltitle'],
                      h1[epub|type~='z3998:covertitle'],
                      docauthor,
                      h1[epub|type~='z3998:author'],
                     .first-page,
                     .second-page,
                     .third-page,
                     .titlepage)) {
                display: block;
        }
}

blockquote, sidebar, aside[epub|type~='sidebar'], epigraph, aside[epub|type~='epigraph'],
.Rammetekst, poem, section[epub|type~='z3998:poem'], div[epub|type~='z3998:poem'], linegroup, section.linegroup, div.linegroup, line, p.line {
        display: block;
}

noteref, a[epub|type~='noteref'] {
        display: inline;
}

note, aside[epub|type~='note'] {
        display: if($include-note-references, block, none);
}

doctitle, h1[epub|type~='fulltitle'], h1[epub|type~='z3998:covertitle'], docauthor, h1[epub|type~='z3998:author'] {
        display: none;
}

/* -------------------------------------------------------------------------- */
/*                Frontmatter                                                 */
/* -------------------------------------------------------------------------- */

frontmatter, level1[epub|type~='frontmatter'] {
        margin-left: 3;
        margin-right: 3;
        text-align: left;
}

.uncontracted-letters, h1 {
        text-transform: uncontracted;
}

.titlepage {
        text-transform: uncontracted;
        margin-left: 1;
        margin-top: 1;
}

/* -------------------------------------------------------------------------- */
/*                other languages                                             */
/* -------------------------------------------------------------------------- */

*[xml|lang]:not([xml|lang|="no"]), *[lang]:not([lang|="no"]) {
    text-transform: uncontracted;
}

/* -------------------------------------------------------------------------- */
/*                class                                                       */
/* -------------------------------------------------------------------------- */
.part h1, h1.part {
        margin-left: 1;
        margin-top: 2;
        text-align: center;
        page-break-before: right;
        border-top: ⠉;
        border-right: ⠸;
        border-bottom: ⠤;
        border-left: ⠇;
}

.precedingemptyline {
        margin-top: 1;
}

.Rammetekst {
        margin-top: 1;
        margin-bottom: 1;
        text-indent: 2;
        text-align: left;
        margin-left: 2;
}

.Rammetekst::before {
        content: "Rammetekst:";
}

/* -------------------------------------------------------------------------- */
/*                element                                                     */
/* -------------------------------------------------------------------------- */

h1, .part h2 {
        page-break-before: right;
        margin-top: 2;
        margin-left: 5;
        margin-right: 5;
        margin-bottom: 1;
        text-align: center;
        border-top: ⠉;
        border-bottom: ⠉;
}

h2, .part h3 {
        margin-top: 2;
        margin-left: 5;
        margin-right: 5;
        margin-bottom: 1;
        text-align: center;
}

h3, .part h4 {
        margin-top: 1;
        margin-left: 5;
        margin-right: 5;
        text-align: center;
}

h4, .part h5 {
        margin-top: 1;
        margin-left: 1;
        margin-right: 5;
        text-align: left;
        text-indent: 0;
}

h5, .part h6 {
        margin-top: 1;
        margin-left: 1;
        margin-right: 5;
        text-align: left;
        text-indent: 0;
}

h5::after, .part h6::after {
        content: ":";
}

h6 {
        margin-top: 1;
        margin-left: 1;
        margin-right: 5;
        text-align: left;
        text-indent: 0;
        border-top: ⠉;
        border-right: ⠉;
        border-bottom: ⠉;
        border-left: ⠉;
}

p {
        text-indent: 2;
        text-align: left;
        widows: 2;
        orphans: 2;
}

blockquote {
        margin-top: 1;
        margin-bottom: 1;
        margin-left: 2;
        text-indent: 2;
        text-align: left;
}

sidebar, aside[epub|type~='sidebar'] {
        margin-top: 1;
        margin-bottom: 1;
        margin-left: 2;
        text-indent: 2;
        text-align: left;
}

sidebar::before, aside[epub|type~='sidebar']::before {
        content: "Margtekst:";
}

epigraph, aside[epub|type~='epigraph'] {
        margin-top: 1;
        margin-bottom: 1;
        margin-left: 2;
        text-indent: 2;
        text-align: left;
}

prodnote::before, aside[epub|type~='z3998:production']::before {
        content: "⠷";
}

prodnote::after, aside[epub|type~='z3998:production']::after {
        content: "⠾";
}

note, aside[epub|type~='note'], noteref, a[epub|type~='noteref'] {
        text-indent: 2;
        text-align: left;
}

/*
 * noteref numbering is implemented in pre-processing.xsl (and pre-processing-epub.xsl)
 * FIXME: could be implemented in CSS
 */

/*
    book {
    counter-reset: note-counter;
}

note:before {
    counter-increment: note-counter;
    content:  counter(note-counter) ". ";
}
*/

/* -------------------------------------------------------------------------- */
/*                Images                                                      */
/* -------------------------------------------------------------------------- */

imggroup, figure {
        display: block;
        
        caption::before {
            content: "Bildetekst:";
        }
        
        caption {
            margin-top: 1;
            margin-bottom: 1;
            margin-left: 2;
            text-indent: 2;
            text-align: left;
        }
}

/* -------------------------------------------------------------------------- */
/*                Poems                                                       */
/* -------------------------------------------------------------------------- */

poem, section[epub|type~='z3998:poem'], div[epub|type~='z3998:poem'] {
        text-indent: 2;
        text-align: left;
}

linegroup, section.linegroup, div.linegroup {
        margin-bottom: 1;
        text-indent: -2;
}

line, p.line {
        margin-left: 2;
        text-indent: -2;
}

/* -------------------------------------------------------------------------- */
/*                Lists                                                       */
/* -------------------------------------------------------------------------- */

list, ul, ol {
        margin-left: 2;
        text-indent: -2;
        margin-bottom: 1;
}

li {
        text-indent: 2;
        text-align: left;
        display: list-item;
}

list, ul, ol {
        counter-reset: list-item;
}

list[type=ul], ul {
        list-style-type: '⠤';
}

list[type=ol], ol {
        list-style-type: decimal;
}

/* -------------------------------------------------------------------------- */
/*                Tables                                                      */
/* -------------------------------------------------------------------------- */

table {
    display: table;
}

table > caption {
    display: block;
    text-indent: 2;
    margin-top: 1;
    margin-bottom: 1;
    text-align: left;
}

table > caption::after {
    display: block;
    text-indent: 2;
    margin-top: 1;
    margin-bottom: 1;
    content: 'Tabell starter';
}

table:not(:has(caption))::before {
    display: block;
    text-indent: 2;
    margin-top: 1;
    margin-bottom: 1;
    content: 'Tabell starter';
}

table::after {
    display: block;
    text-indent: 2;
    margin-top: 1;
    margin-bottom: 1;
    content: 'Tabell slutter';
}

/* -------------------------------------------------------------------------- */
/*                Note and endnote                                            */
/* -------------------------------------------------------------------------- */
@page {
        @footnotes {
                content: flow(footnotes);
                -obfl-fallback-collection: endnotes;
        }
}

@page {
        @footnotes {
                max-height: 15;
        }
}

@volume {
        @end {
                content: flow(endnotes, volume);
        }
}

noteref::before, a[epub|type~='noteref']::before {
        content: '⠠';
}

noteref::alternate, a[epub|type~='noteref']::alternate {
        flow: endnotes;
        display: block;
        content: target-content(attr(idref));
}

level1.footnotes {
        display: none;
}

note p::before, aside[epub|type~='note'] p::before {
        content: '⠠';
}

note p, aside[epub|type~='note'] p::before {
        margin-left: 4;
        text-indent: -2;
}
